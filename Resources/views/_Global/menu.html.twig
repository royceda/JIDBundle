<script type="text/javascript">
/* Gestion du menu contextuel */
function onButtonClick(menuitemId, type) {
    var data = mygrid.contextID.split("_");
    //rowInd_colInd;
    var rId = data[0];
    var cInd = data[1];
//     mygrid.setRowTextStyle(data[0], "color:" + menuitemId.split("_")[1]);
    // alert("rId "+rId+" cInd "+cInd);
    spooler = mygrid.cells(rId,0).getValue();
    switch (menuitemId) {
       case "spooler_go":
           window.open("/js/"+spooler, spooler);
            break;
       case "show_info":
            JobInfo( rId );
        break;
        case "doc":
            window.open('{{ url('arii_JID_job_doc') }}?id='+rId,'arii_doc');
            break;
       case "job_history":
            document.location.href = "{{ url('arii_JID_history_job') }}?id="+rId;
        break;
        case "start_task":
            Job(    "start_job", rId,
                    "{{ "Start job" | trans }}",
                    "{{ url('xml_JID_job_toolbar_start') }}",
                    true );
            break;
        case "stop_job":
            Job(    "stop_job", rId,
                    "{{ "Stop job" | trans }}",
                    "{{ url('xml_JID_job_toolbar_stop') }}",
                    false );
            break;
        case "unstop_job":
            Job(    "unstop_job", rId,
                    "{{ "Unstop job" | trans }}",
                    "{{ url('xml_JID_job_toolbar_unstop') }}",
                    false );
            break;
        case "kill_task":
            Job(    "kill_task", rId,
                    "{{ "Kill task" | trans }}",
                    "{{ url('xml_JID_job_toolbar_kill_task') }}",
                    false );
            break;
        case "delete_task":
            Job(    "delete_task", rId,
                    "{{ "Delete task" | trans }}",
                    "{{ url('xml_JID_job_toolbar_delete_task') }}",
                    false );
            break;
        case "show_why":
            ShowWhy( rId);
            break;
        case "pause_spooler":
            Spooler("{{ url('arii_XML_Command') }}?command=pause_spooler&spooler_id",'  '+spooler);
            break;
        case "continue_spooler":
            Spooler("{{ url('arii_XML_Command') }}?command=continue_spooler&spooler_id",'  '+spooler);
            break;
        case "check_spooler":
            Spooler("{{ url('arii_JID_spooler_update') }}?id",'  '+spooler);
            break;
        case "terminate_spooler":
            Spooler("{{ url('arii_XML_Command') }}?command=restart_spooler&spooler_id",'  '+spooler);
            break;
        case "abort_spooler":
            Spooler("{{ url('arii_XML_Command') }}?command=abort_spooler&spooler_id",rId);
            break;
        case "purge_job":
            PurgeJob( rId );
        break;
        case "job_detail":
            JobDetail( rId );
        break;
        default:
            alert("inconnu ! "+menuitemId);    
    }
    return true;
}
menu.attachEvent("onClick", onButtonClick);

var dhxCalendar;
var msg;

function Job( Command, id, Text, Toolbar, Time ) { 
    var largeur = 600;
        msg = dhxWins.createWindow( "msgwin" , (document.getElementById("wrapper").offsetWidth-largeur)/2, 50, largeur, 500 );
        msg.setText(Text+' '+id);
    var winLayout;
    winLayout = msg.attachLayout("1C");
    winLayout.cells("a").hideHeader();
    winLayout.cells("a").setHeight(300);

    var winbar = winLayout.cells("a").attachTabbar();
    // tabbar.setImagePath("{{asset("arii/dhtmlx/dhtmlxTabbar/codebase/imgs/")}}");
    winbar.setSkin("dhx_skyblue");
    winbar.addTab("b1","{{ "Detail" | trans }}","100px", null, true);
    winbar.addTab("b2","{{ "Parameters" | trans }}","100px");

    winbar.cells("b1").attachURL("{{ url('arii_JID_detail_job') }}?id="+id,true);
    
    var toolbar = winLayout.cells("a").attachToolbar();
    toolbar.setIconsPath("{{ asset('arii/images/toolbar/') }}");
    toolbar.loadStruct( Toolbar, function(){
        if (Time) {
            GBCalendar = new dhtmlXCalendarObject(toolbar.getInput('ref_date'));
            GBCalendar.setDateFormat("%Y-%m-%d %H:%i:%s");
            GBCalendar.setWeekStartDay(1);
        }
    });
    
    var toolbar2 = winbar.cells("b2").attachToolbar();
    toolbar2.setIconsPath("{{ asset('arii/images/toolbar/') }}");
    toolbar2.loadStruct("{{ url('xml_JID_job_toolbar_params') }}");

    var dhxgrid = winbar.cells("b2").attachGrid();
    dhxgrid.selMultiRows = true;
    dhxgrid.setHeader("{{ "Name" | trans }},{{ "Value" | trans }}");
    dhxgrid.setColTypes("ed,ed");
    dhxgrid.setInitWidths("*,*");
    dhxgrid.init();
    dhxgrid.loadXML("{{ url('xml_JID_start_job_parameters') }}?id="+id);

    toolbar.attachEvent("onClick",function(itemid){
        switch(itemid) {
            case "start_job":
            case "stop_job":
            case "unstop_job":
            case "delete_task":
            case "kill_task":
                msg.progressOn();
                var params = new Array();
                dhxgrid.forEachRow(function(id){
                    var param = dhxgrid.cells(id,0).getValue() + "=" + encodeURIComponent(dhxgrid.cells(id,1).getValue());
                    params.push(param);
                });
                var paramsStr = params.join(",");
                var start_time = '';
                if (Time)
                    start_time = toolbar.getValue("ref_date");
                dhtmlx.message({
                type: "Notice",
                text: Text+" <strong>"+id+"</strong>" });
                msg.close();
                alert("{{ url('arii_XML_Command') }}?command="+Command+"&params="+encodeURIComponent(params)+"&time="+start_time+"&job_id="+id); 
                dhxLayout.cells("a").progressOn();
                dhtmlxAjax.post("{{ url('arii_XML_Command') }}","command="+Command+"&params="+encodeURIComponent(params)+"&time="+start_time+"&job_id="+id,function(loader,response){
                    dhtmlx.message({
                    type: "Notice",
                    expire: 10000,
                    width: "500px",
                    text: loader.xmlDoc.responseText });
                    GridRefresh();
                    dhxLayout.cells("a").progressOff();
                });
                break;
            case "cancel":
                msg.close();
                break;
            default:
                alert(itemid);
                break;
        }
        return true;
    });
    
    toolbar2.attachEvent("onClick",function(itemid){
        switch(itemid) {
            case "new":
                dhxgrid.addRow(dhxgrid.getRowsNum()+1,"");
                break;
            default:
                break;
        }
        return true;
    });

return true;
}

function ShowWhy( id ) { 
    largeur = 900;
    msg = dhxWins.createWindow( "msgwin" ,  (document.getElementById("wrapper").offsetWidth-largeur)/2, 50, largeur, 550 );
    msg.setText("{{ "Diagnostic" | trans }} ");

    winLayout = msg.attachLayout("1C");
    winLayout.cells("a").hideHeader();
    winLayout.cells("a").progressOn();
    
    toolbar = winLayout.cells("a").attachToolbar();
    toolbar.setIconsPath("{{ asset('arii/images/toolbar/') }}");
    toolbar.loadXML("{{ url('arii_JID_toolbar_job_why') }}");
    toolbar.attachEvent("onClick",function(buttonId){
        switch (buttonId) {
            case "cancel":
                msg.close();
                break;
            default:
                alert(buttonId);
        }
        return true;
    });

    var dhxgrid = winLayout.cells("a").attachGrid();
    dhxgrid.setHeader("{{ "Name" | trans }},{{ "Value" | trans }}");
    dhxgrid.setColTypes("tree,ro");
    dhxgrid.enableTreeGridLines(true);
    dhxgrid.setInitWidths("400,*");
    dhxgrid.init();
    dhxgrid.load("{{ url('arii_XML_Command') }}?command=why_job&job_id="+id, function () {
        winLayout.cells("a").progressOff();    
    });
}


function PurgeJob( id ) { 
    var largeur = 600;
        msg = dhxWins.createWindow( "msgwin" ,  (document.getElementById("wrapper").offsetWidth-largeur)/2, 200, largeur, 400 );
        msg.setText("{{ "Purge job" | trans }} "+id);

    var winLayout;
    winLayout = msg.attachLayout("1C");
    winLayout.cells("a").hideHeader();
    winLayout.cells("a").attachURL("{{ url('arii_JID_detail_job') }}?id="+id,true);

    var toolbar;
    toolbar = winLayout.cells("a").attachToolbar();
    toolbar.setIconsPath("{{ asset('arii/images/toolbar/') }}");
    toolbar.loadXML("{{ url('arii_JID_toolbar_purge_job') }}");

    toolbar.attachEvent("onClick",function(itemid){
        switch (itemid) {
            case "stop":
                msg.progressOn();
                dhtmlx.message({
                type: "Notice",
                text: "{{ "Purge job" | trans }} <strong>"+id+"</strong>" });
                msg.close();
                dhtmlxAjax.post("{{ url('arii_JID_history_purge') }}","job_id="+id,function(loader,response){
                    dhtmlx.message({
                    type: "Notice",
                    expire: 10000,
                    width: "500px",
                    text: loader.xmlDoc.responseText });
                    GridRefresh();
                });
                break;
            case "cancel":
                msg.close();
                break;
            default: 
                break;
        }
        return true;
    });
    
return true;
}

// Fonctions
function Spooler(url,rid)
{
    dhxLayout.cells("a").progressOn();
    dhtmlxAjax.get(url+"="+rid.substr(2),function(loader,response){
        dhxLayout.cells("a").progressOff();
        dhtmlx.message({
            type: "Notice",
            expire: 10000,
            width: "500px",
            text: loader.xmlDoc.responseText
        });
        CheckSpooler(rid);
    });
    return true;
}
</script>